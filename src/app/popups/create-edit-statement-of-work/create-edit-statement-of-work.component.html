<div class="create-edit-sow-container">
  <p-toast></p-toast>

  <form [formGroup]="StatementOfWorkForm" (ngSubmit)="onSubmit()">
    <div class="form-grid">
      <!-- Name -->
      <div class="field">
        <label for="name">Project Name*</label>
        <input
          id="name"
          type="text"
          pInputText
          formControlName="name"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('name')?.invalid &&
              StatementOfWorkForm.get('name')?.touched
          }"
        />
        <small
          *ngIf="
            StatementOfWorkForm.get('name')?.invalid &&
            StatementOfWorkForm.get('name')?.touched
          "
          class="p-error"
        >
          Project Name is required
        </small>
      </div>

      <!-- Project State -->
      <div class="field">
        <label for="projectState">Project State*</label>
        <p-select
          id="projectState"
          formControlName="projectState"
          [options]="projectStateOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select Project State"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('projectState')?.invalid &&
              StatementOfWorkForm.get('projectState')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('projectState')?.invalid &&
            StatementOfWorkForm.get('projectState')?.touched
          "
          class="p-error"
        >
          Project State is required
        </small>
      </div>

      <!-- Start Date -->
      <div class="field">
        <label for="startDate">Start Date*</label>
        <p-datepicker
          id="startDate"
          formControlName="startDate"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('startDate')?.invalid &&
              StatementOfWorkForm.get('startDate')?.touched
          }"
        ></p-datepicker>
        <small
          *ngIf="
            StatementOfWorkForm.get('startDate')?.invalid &&
            StatementOfWorkForm.get('startDate')?.touched
          "
          class="p-error"
        >
          Start Date is required
        </small>
      </div>

      <!-- End Date -->
      <div class="field">
        <label for="endDate">End Date*</label>
        <p-datepicker
          id="endDate"
          formControlName="endDate"
          [showIcon]="true"
          dateFormat="yy-mm-dd"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('endDate')?.invalid &&
              StatementOfWorkForm.get('endDate')?.touched
          }"
        ></p-datepicker>
        <small
          *ngIf="
            StatementOfWorkForm.get('endDate')?.invalid &&
            StatementOfWorkForm.get('endDate')?.touched
          "
          class="p-error"
        >
          End Date is required
        </small>
      </div>

      <!-- Line Manager -->
      <div class="field">
        <label for="lineManagerId">Line Manager*</label>
        <p-select
          id="lineManagerId"
          formControlName="lineManagerId"
          [options]="lineManagersOptions()"
          optionLabel="firstName"
          optionValue="id"
          placeholder="Select Line Manager"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('lineManagerId')?.invalid &&
              StatementOfWorkForm.get('lineManagerId')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('lineManagerId')?.invalid &&
            StatementOfWorkForm.get('lineManagerId')?.touched
          "
          class="p-error"
        >
          Line Manager is required
        </small>
      </div>

      <!-- CSX Escalation Manager -->
      <div class="field">
        <label for="escalationManagerId">CSX Escalation Manager*</label>
        <p-select
          id="escalationManagerId"
          formControlName="escalationManagerId"
          [options]="csxEscalationManagersOptions()"
          optionLabel="firstName"
          optionValue="id"
          placeholder="Select CSX Escalation Manager"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('escalationManagerId')?.invalid &&
              StatementOfWorkForm.get('escalationManagerId')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('escalationManagerId')?.invalid &&
            StatementOfWorkForm.get('escalationManagerId')?.touched
          "
          class="p-error"
        >
          CSX Escalation Manager is required
        </small>
      </div>

      <!-- Compnova Escalation Manager -->
      <div class="field">
        <label for="compnovaEscalationManagerId"
          >Compnova Escalation Manager*</label
        >
        <p-select
          id="compnovaEscalationManagerId"
          formControlName="compnovaEscalationManagerId"
          [options]="compnovaEscalationManagersOptions()"
          optionLabel="firstName"
          optionValue="id"
          placeholder="Select Compnova Escalation Manager"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('compnovaEscalationManagerId')?.invalid &&
              StatementOfWorkForm.get('compnovaEscalationManagerId')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('compnovaEscalationManagerId')?.invalid &&
            StatementOfWorkForm.get('compnovaEscalationManagerId')?.touched
          "
          class="p-error"
        >
          Compnova Escalation Manager is required
        </small>
      </div>

      <!-- Authorized Signature -->
      <div class="field">
        <label for="authorizedSignatureId">Authorized Signature*</label>
        <p-select
          id="authorizedSignatureId"
          formControlName="authorizedSignatureId"
          [options]="authorizedSignaturesOptions()"
          optionLabel="firstName"
          optionValue="id"
          placeholder="Select Authorized Signature"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('authorizedSignatureId')?.invalid &&
              StatementOfWorkForm.get('authorizedSignatureId')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('authorizedSignatureId')?.invalid &&
            StatementOfWorkForm.get('authorizedSignatureId')?.touched
          "
          class="p-error"
        >
          Authorized Signature is required
        </small>
      </div>

      <!-- Type -->
      <div class="field">
        <label for="type">Type*</label>
        <p-select
          id="type"
          formControlName="type"
          [options]="typeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select Type"
          styleClass="w-full"
          [appendTo]="overlayAppendTo"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('type')?.invalid &&
              StatementOfWorkForm.get('type')?.touched
          }"
        ></p-select>
        <small
          *ngIf="
            StatementOfWorkForm.get('type')?.invalid &&
            StatementOfWorkForm.get('type')?.touched
          "
          class="p-error"
        >
          Type is required
        </small>
      </div>

      <!-- Fixed Bid Amount -->
      @if(StatementOfWorkForm.get('type')?.value === 'FIXED_BID') {
      <div class="field">
        <label for="fixedBidAmount">Fixed Bid Amount*</label>
        <p-inputNumber
          id="fixedBidAmount"
          formControlName="fixedBidAmount"
          mode="currency"
          currency="USD"
          locale="en-US"
          [minFractionDigits]="2"
          [ngClass]="{
            'ng-invalid ng-dirty':
              StatementOfWorkForm.get('fixedBidAmount')?.invalid &&
              StatementOfWorkForm.get('fixedBidAmount')?.touched
          }"
        ></p-inputNumber>
        <small
          *ngIf="
            StatementOfWorkForm.get('fixedBidAmount')?.invalid &&
            StatementOfWorkForm.get('fixedBidAmount')?.touched
          "
          class="p-error"
        >
          Fixed Bid Amount is required
        </small>
      </div>
      }
    </div>

    <!-- Description -->
    <div class="field">
      <label for="description">Description</label>
      <textarea
        id="description"
        pTextarea
        formControlName="description"
        rows="3"
      ></textarea>
    </div>

    <div class="field">
      <label for="projectScope">Project Scope</label>
      <textarea
        id="projectScope"
        pTextarea
        formControlName="projectScope"
        rows="3"
      ></textarea>
    </div>

    <div class="field">
      <label for="teamsAndConditions">Teams And Conditions</label>
      <textarea
        id="teamsAndConditions"
        pTextarea
        formControlName="teamsAndConditions"
        rows="3"
      ></textarea>
    </div>

    <div class="field">
      <label for="assumptionsAndDependencies"
        >Assumptions And Dependencies</label
      >
      <textarea
        id="assumptionsAndDependencies"
        pTextarea
        formControlName="assumptionsAndDependencies"
        rows="3"
      ></textarea>
    </div>

    <div class="positions-section">
      <div class="section-header">
        <h3>Positions</h3>
        <p-button
          label="Add Position"
          icon="pi pi-plus"
          styleClass="p-button-sm p-button-success"
          (click)="addPosition()"
        ></p-button>
      </div>

      <div class="positions-table" *ngIf="positions.length > 0">
        <p-table
          [value]="positions.controls"
          styleClass="p-datatable-sm"
          responsiveLayout="scroll"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 45%">Position</th>
              <th style="width: 35%">Type</th>
              <th style="width: 10%">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-position let-i="rowIndex">
            <tr [formGroup]="position">
              <td>
                <p-select
                  formControlName="positionId"
                  [options]="positionsOptions()"
                  optionLabel="title"
                  optionValue="id"
                  placeholder="Select Position"
                  styleClass="w-full"
                  [appendTo]="overlayAppendTo"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      position.get('positionId')?.invalid &&
                      position.get('positionId')?.touched
                  }"
                ></p-select>
              </td>
              <td>
                <p-select
                  formControlName="type"
                  [options]="positionTypeOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select Type"
                  styleClass="w-full"
                  [appendTo]="overlayAppendTo"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      position.get('type')?.invalid &&
                      position.get('type')?.touched
                  }"
                ></p-select>
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-rounded p-button-danger p-button-text"
                  (click)="removePosition(i)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">No positions added</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="no-positions" *ngIf="positions.length === 0">
        <p>
          No positions added. Click "Add Position" to add a position to this
          Statement of Work.
        </p>
      </div>
    </div>

    <div class="positions-section">
      <div class="section-header">
        <h3>Activities and Deliverables Timeline</h3>
        <p-button
          label="Add Activity"
          icon="pi pi-plus"
          styleClass="p-button-sm p-button-success"
          (click)="addActivity()"
        ></p-button>
      </div>

      <div class="positions-table" *ngIf="activities.length > 0">
        <p-table
          [value]="activities.controls"
          styleClass="p-datatable-sm"
          responsiveLayout="scroll"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Phase</th>
              <th>Activity</th>
              <th>Deliverable</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-activity let-i="rowIndex">
            <tr [formGroup]="activity">
              <td>
                <input
                  id="phase"
                  type="text"
                  pInputText
                  formControlName="phase"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      activity.get('phase')?.invalid &&
                      activity.get('phase')?.touched
                  }"
                />
                <small
                  *ngIf="
                    activity.get('phase')?.invalid &&
                    activity.get('phase')?.touched
                  "
                  class="p-error"
                >
                  Phase is required
                </small>
              </td>
              <td>
                <input
                  id="name"
                  type="text"
                  pInputText
                  formControlName="name"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      activity.get('name')?.invalid &&
                      activity.get('name')?.touched
                  }"
                />
                <small
                  *ngIf="
                    activity.get('name')?.invalid &&
                    activity.get('name')?.touched
                  "
                  class="p-error"
                >
                  Activity Name is required
                </small>
              </td>
              <td>
                <textarea
                  id="deliverable"
                  pTextarea
                  formControlName="deliverable"
                  rows="3"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      activity.get('deliverable')?.invalid &&
                      activity.get('deliverable')?.touched
                  }"
                ></textarea>
                <small
                  *ngIf="
                    activity.get('deliverable')?.invalid &&
                    activity.get('deliverable')?.touched
                  "
                  class="p-error"
                >
                  Deliverable is required
                </small>
              </td>
              <td>
                <p-datepicker
                  id="startDate"
                  formControlName="startDate"
                  [showIcon]="true"
                  dateFormat="yy-mm-dd"
                  [appendTo]="overlayAppendTo"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      activity.get('startDate')?.invalid &&
                      activity.get('startDate')?.touched
                  }"
                ></p-datepicker>
                <small
                  *ngIf="
                    activity.get('startDate')?.invalid &&
                    activity.get('startDate')?.touched
                  "
                  class="p-error"
                >
                  Start Date is required
                </small>
              </td>
              <td>
                <!-- End Date -->

                <p-datepicker
                  id="endDate"
                  formControlName="endDate"
                  [showIcon]="true"
                  dateFormat="yy-mm-dd"
                  [appendTo]="overlayAppendTo"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      activity.get('endDate')?.invalid &&
                      activity.get('endDate')?.touched
                  }"
                ></p-datepicker>
                <small
                  *ngIf="
                    activity.get('endDate')?.invalid &&
                    activity.get('endDate')?.touched
                  "
                  class="p-error"
                >
                  End Date is required
                </small>
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-rounded p-button-danger p-button-text"
                  (click)="removeActivity(i)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">No positions added</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="no-positions" *ngIf="activities.length === 0">
        <p>
          No activities added. Click "Add Activity" to add a activity to this
          Statement of Work.
        </p>
      </div>
    </div>

    <!-- Positions Section -->
    <div class="positions-section">
      <div class="section-header">
        <h3>Mileposts</h3>
        <p-button
          label="Add Milepost"
          icon="pi pi-plus"
          styleClass="p-button-sm p-button-success"
          (click)="addMilepost()"
        ></p-button>
      </div>

      <div class="positions-table" *ngIf="mileposts.length > 0">
        <p-table
          [value]="mileposts.controls"
          styleClass="p-datatable-sm"
          responsiveLayout="scroll"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Due Date</th>
              <th>Amount</th>
              <th style="width: 10%">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-milepost let-i="rowIndex">
            <tr [formGroup]="milepost">
              <td>
                <input
                  id="name"
                  type="text"
                  pInputText
                  formControlName="name"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      milepost.get('name')?.invalid &&
                      milepost.get('name')?.touched
                  }"
                />
                <small
                  *ngIf="
                    milepost.get('name')?.invalid &&
                    milepost.get('name')?.touched
                  "
                  class="p-error"
                >
                  Milepost Name is required
                </small>
              </td>
              <td>
                <textarea
                  id="description"
                  pTextarea
                  formControlName="description"
                  rows="3"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      milepost.get('description')?.invalid &&
                      milepost.get('description')?.touched
                  }"
                ></textarea>
                <small
                  *ngIf="
                    milepost.get('description')?.invalid &&
                    milepost.get('description')?.touched
                  "
                  class="p-error"
                >
                  Description is required
                </small>
              </td>
              <td>
                <p-datepicker
                  id="dueDate"
                  formControlName="dueDate"
                  [showIcon]="true"
                  dateFormat="yy-mm-dd"
                  [appendTo]="overlayAppendTo"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      milepost.get('dueDate')?.invalid &&
                      milepost.get('dueDate')?.touched
                  }"
                ></p-datepicker>
                <small
                  *ngIf="
                    milepost.get('dueDate')?.invalid &&
                    milepost.get('dueDate')?.touched
                  "
                  class="p-error"
                >
                  Due Date is required
                </small>
              </td>
              <td>
                <p-inputNumber
                  id="amount"
                  formControlName="amount"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  [minFractionDigits]="2"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      milepost.get('amount')?.invalid &&
                      milepost.get('amount')?.touched
                  }"
                ></p-inputNumber>
                <small
                  *ngIf="
                    milepost.get('amount')?.invalid &&
                    milepost.get('amount')?.touched
                  "
                  class="p-error"
                >
                  Amount is required
                </small>
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-rounded p-button-danger p-button-text"
                  (click)="removeMilepost(i)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">No Milepost added</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div class="no-positions" *ngIf="mileposts.length === 0">
        <p>
          No mileposts added. Click "Add milepost" to add a milepost to this
          Statement of Work.
        </p>
      </div>
    </div>

    <div class="form-actions">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        styleClass="p-button-text"
        (click)="onCancel()"
      ></p-button>
      <p-button
        type="submit"
        label="Save"
        icon="pi pi-check"
        [loading]="loading"
        [disabled]="StatementOfWorkForm.invalid"
      ></p-button>
    </div>
  </form>
</div>
